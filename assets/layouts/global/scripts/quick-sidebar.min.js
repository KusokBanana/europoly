var QuickSidebar=function(){var a=$(".page-quick-sidebar-wrapper");var f=a.find(".page-quick-sidebar-chat");var n=$("#messages-wrapper");var b=$(".chat-quick-messages-count");var k=n.find(".page-quick-sidebar-chat-users ul.list-items.chat-users-list");var e=n.attr("data-user-id");var c=f.find(".page-quick-sidebar-chat-user-messages");var l=f.find(".page-quick-sidebar-chat-user-form .form-control");var j=false;var d=function(r){var q="";var s=(r.avatar&&r.avatar!=="null")?"../avatars/"+r.avatar:"../avatars/user.png";q+='<div class="post '+r.dir+'" data-message-id="'+r.id+'">';q+='<img class="avatar" alt="User avatar" src="'+s+'"/>';q+='<div class="message">';q+='<span class="arrow"></span>';q+='<a href="#" class="name">'+r.name+"</a>&nbsp;";q+='<span class="datetime">'+r.time+"</span>";q+='<span class="body">';q+=r.message;q+="</span>";q+="</div>";q+="</div>";c.append(q)};var p=function(u){var w=(+u.count_new)?u.count_new:"";var y=$(document.createElement("li"));y.addClass("media").attr("data-user-id",u.user_id);var x=$(document.createElement("div"));x.addClass("media-status");var v=$(document.createElement("span"));v.addClass("badge badge-success").text(w);x.append(v);var s=$(document.createElement("img"));var q=(u.avatar&&u.avatar!=="null")?"../avatars/"+u.avatar:"../avatars/user.png";s.addClass("media-object").attr("src",q).attr("alt","User avatar");var r=$(document.createElement("div"));r.addClass("media-body");var z=$(document.createElement("h4"));z.addClass("media-heading").text(u.name);var t=$(document.createElement("div"));t.addClass("media-heading-sub").text(u.role_name);r.append(z).append(t);y.append(x).append(s).append(r);k.prepend(y)};var i=function(q,s){var r={user_id:e,type:q};if(s!==undefined){r.companion_id=s}$.ajax({url:"/chat/check_messages",type:"POST",data:r,success:function(v){if(v){v=JSON.parse(v);console.log(v);if(q=="count_users"){var x=v.users;if(x.length){$.each(x,function(y){var z=this.user_id;var A=k.find('li.media[data-user-id="'+z+'"]');if(A.length){var C=(+this.count_new)?this.count_new:"";A.find(".media-status > span").text(C);var B=x.length-1;A.attr("data-sort",B-y);if(A.index()!=B-y){}}else{p(this)}});k.find("li.media[data-sort]").sort(function(z,y){z=$(z).attr("data-sort");y=$(y).attr("data-sort");return z<y?-1:z>y?1:0}).appendTo(k)}}else{if(q=="user_chat"){var t=v.dialog;if(t.length){var u=false;$.each(t,function(){var y=c.find('div.post[data-message-id="'+this.id+'"]');if(!y.length){u=true;d(this)}});if(u){c.slimScroll({scrollTo:c[0].scrollHeight})}}}}var w=(+v.total_count_new)?v.total_count_new:"";b.text(w)}}})};var o=function(){$(".dropdown-quick-sidebar-toggler a, .page-quick-sidebar-toggler, .quick-sidebar-toggler").click(function(s){var q=$("body");var r=$(this).attr("data-id");q.toggleClass("page-quick-sidebar-open "+r);if(q.hasClass("page-quick-sidebar-open chat")){i("count_users")}})};var h=function(){var u=function(){var x=a.find(".page-quick-sidebar-chat-users");var y;y=a.height()-a.find(".nav-tabs").outerHeight(true);App.destroySlimScroll(x);x.attr("data-height",y);App.initSlimScroll(x);var w=c;var v=y-f.find(".page-quick-sidebar-chat-user-form").outerHeight(true);v=v-f.find(".page-quick-sidebar-nav").outerHeight(true);App.destroySlimScroll(w);w.attr("data-height",v);App.initSlimScroll(w)};u();App.addResizeHandler(u);a.on("click",".page-quick-sidebar-chat-users .media-list > .media",function(){l.focus();var v=$(this).attr("data-user-id");var w=f.find("#companion_id").val();if(w&&w!==v){c.empty()}f.find("#companion_id").val(v);i("user_chat",v);f.addClass("page-quick-sidebar-content-item-shown");c.slimScroll({scrollTo:"1000000px"});q(e,v)});a.on("click",".page-quick-sidebar-chat-user .page-quick-sidebar-back-to-list",function(){i("count_users");f.removeClass("page-quick-sidebar-content-item-shown")});var t=function(w){w.preventDefault();var x=l.val();if(x.length===0){return}var v=f.find("#companion_id").val();$.ajax({url:"/chat/send_message",type:"POST",data:{user_id:e,companion_id:v,message:x},success:function(z){if(z){z=JSON.parse(z);var y=c.find(".post.out:first");z.name=y.find(".name").text();z.avatar=y.find(".avatar").attr("src");d(z)}}});c.slimScroll({scrollTo:c[0].scrollHeight});l.val("")};f.find(".page-quick-sidebar-chat-user-form .btn").click(t);f.find(".page-quick-sidebar-chat-user-form .form-control").keypress(function(v){if(v.which==13){t(v);return false}});var r=function(){var v;var x=(+n.css("right").slice(0,-2)>=0);var w;if(x||!j){j=true;if(f.hasClass("page-quick-sidebar-content-item-shown")){w=f.find("#companion_id").val();v="user_chat";q(e,w)}else{v="count_users"}}else{v="count"}i(v,w)};var q=function(v,w){$.ajax({url:"/chat/read_messages",type:"POST",data:{user_id:v,companion_id:w}})};r();var s=setInterval(function(){r()},3000)};var g=function(){var s=$(".page-quick-sidebar-wrapper");var r=s.find(".page-quick-sidebar-alerts");var q=function(){var u=s.find(".page-quick-sidebar-alerts-list");var t;t=s.height()-s.find(".nav-justified > .nav-tabs").outerHeight();App.destroySlimScroll(u);u.attr("data-height",t);App.initSlimScroll(u)};q();App.addResizeHandler(q)};var m=function(){var s=$(".page-quick-sidebar-wrapper");var r=s.find(".page-quick-sidebar-settings");var q=function(){var t=s.find(".page-quick-sidebar-settings-list");var u;u=s.height()-s.find(".nav-justified > .nav-tabs").outerHeight();App.destroySlimScroll(t);t.attr("data-height",u);App.initSlimScroll(t)};q();App.addResizeHandler(q)};return{init:function(){o();h();g();m()}}}();if(App.isAngularJsApp()===false){jQuery(document).ready(function(){QuickSidebar.init()})};